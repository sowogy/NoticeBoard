<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml"
      th:replace="~{default-board::layout(~{::section})}">
<body>
<section class = "container">
    <h1>게시판</h1>
    <form th:object="${article}" th:action="@{/article/edit}" method="post">
        <input type="hidden" name="id" th:value="*{id}"/>
        <div class="mb-3">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" th:field="*{title}">
            <p th:if="${#fields.hasErrors('title')}" th:errors="*{title}"
               class="text-danger">Title Error</p>
        </div>
        <div class="mb-3">
            <label class="form-label">내용</label>
            <textarea class="form-control" th:field="*{description}" rows="10"></textarea>
            <p th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></p>
        </div>

        <!-- 파일 -->
        <div class="mb-3">

            <!-- 숨김 필드: 삭제 여부 -->
            <input type="hidden" id="removeFileField" name="removeFile" value="false"/>

            <table class="table align-middle mb-2">
                <thead>
                <tr>
                    <th style="width:40%">파일명</th>
                    <th style="width:20%">업로드 상태</th>
                    <th style="width:15%">용량</th>
                    <th style="width:25%">액션</th>
                </tr>
                </thead>
                <tbody>
                <!-- 기존 파일 있을 때 -->
                <tr th:if="${articleDTO != null and articleDTO.fileUrl != null and !#strings.isEmpty(articleDTO.fileUrl)}">
                    <td>
                        <span class="me-2">📄</span>
                        <a th:href="${articleDTO.fileUrl}" target="_blank"
                           th:text="${articleDTO.fileTitle}">첨부파일.pdf</a>
                    </td>
                    <td>
                        <span id="fileStatusExisting" class="badge bg-secondary">유지</span>
                    </td>
                    <td>
                          <span id="fileSizeTextExisting"
                                th:text="${#numbers.formatDecimal(articleDTO.fileSize/1024.0/1024.0,1,1)} + ' MB'">0 KB</span>
                    </td>
                    <td>
                        <!-- 교체: 숨겨진 file input을 버튼으로 트리거 -->
                        <input id="fileInputExisting" type="file" name="file" class="d-none"
                               accept=".pdf,.ppt,.pptx,.hwp,.hwpx,.doc,.docx"/>
                        <button type="button" class="btn btn-outline-primary btn-sm me-1" id="replaceBtnExisting">교체</button>

                        <!-- 삭제 -->
                        <button type="button" class="btn btn-outline-danger btn-sm me-1" id="removeBtnExisting">삭제</button>

                        <!-- 다운로드 바로가기(선택) -->
                        <a class="btn btn-outline-secondary btn-sm" th:href="${articleDTO.fileUrl}" download>다운로드</a>
                    </td>
                </tr>

                <!-- 기존 파일 없을 때: 새 업로드 -->
                <tr th:if="${articleDTO == null or articleDTO.fileUrl == null or #strings.isEmpty(articleDTO.fileUrl)}">
                    <td colspan="4">
                        <input id="fileInputNew" type="file" name="file" class="form-control"
                               accept=".pdf,.ppt,.pptx,.hwp,.hwpx,.doc,.docx"/>
                        <div class="form-text">허용 확장자: PDF/PPT/PPTX/HWP/HWPX/DOC/DOCX · 최대 20MB</div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- 유효성 에러 -->
            <p th:if="${#fields.hasErrors('file')}" th:errors="*{file}" class="text-danger mt-1"></p>

            <!-- PDF 미리보기(선택) -->
            <div id="serverPdfPreview" class="mt-3"
                 th:if="${articleDTO != null and articleDTO.fileContentType != null and articleDTO.fileContentType.contains('pdf')}">
                <embed th:src="@{${articleDTO.fileUrl}}" type="application/pdf" width="100%" height="600"/>
            </div>
        </div>

        <script>
            (function () {
                // 공용 유틸
                function fmtMB(bytes) {
                    return (bytes / 1024 / 1024).toFixed(1) + ' MB';
                }
                function isPdf(file) {
                    if (!file) return false;
                    if (file.type && file.type.toLowerCase().includes('pdf')) return true;
                    return /\.pdf$/i.test(file.name || '');
                }

                // 서버 미리보기 보이기/숨기기
                function hideServerPreview() {
                    var el = document.getElementById('serverPdfPreview');
                    if (el) el.style.display = 'none';
                }
                function showServerPreview() {
                    var el = document.getElementById('serverPdfPreview');
                    if (el) el.style.display = '';
                }

                // 클라이언트 미리보기 컨테이너
                function ensurePreviewContainer() {
                    var container = document.getElementById('clientPdfPreview');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'clientPdfPreview';
                        container.className = 'mt-3';
                        var fileBlock = document.querySelector('.mb-3 .table')?.parentElement || document.querySelector('.mb-3');
                        (fileBlock || document.body).appendChild(container);
                    }
                    return container;
                }

                let currentObjectUrl = null;
                function clearClientPreview() {
                    const container = document.getElementById('clientPdfPreview');
                    if (container) container.innerHTML = '';
                    if (currentObjectUrl) {
                        URL.revokeObjectURL(currentObjectUrl);
                        currentObjectUrl = null;
                    }
                }
                function showPdfPreview(file) {
                    clearClientPreview();
                    if (!isPdf(file)) return;
                    const url = URL.createObjectURL(file);
                    currentObjectUrl = url;
                    const container = ensurePreviewContainer();
                    const embed = document.createElement('embed');
                    embed.setAttribute('src', url);
                    embed.setAttribute('type', 'application/pdf');
                    embed.setAttribute('width', '100%');
                    embed.setAttribute('height', '420');
                    container.appendChild(embed);
                }

                // 요소 참조(기존/신규 케이스 중 있는 것만)
                const inputExisting = document.getElementById('fileInputExisting');
                const inputNew      = document.getElementById('fileInputNew');
                const replaceBtn    = document.getElementById('replaceBtnExisting');
                const removeBtn     = document.getElementById('removeBtnExisting');
                const statusEl      = document.getElementById('fileStatusExisting');
                const sizeEl        = document.getElementById('fileSizeTextExisting');
                const removeField   = document.getElementById('removeFileField');

                // 기존 파일 행에서 파일명 링크 요소
                let nameLinkExisting = null;
                if (inputExisting) {
                    const row = inputExisting.closest('tr');
                    if (row) nameLinkExisting = row.querySelector('a[href]');
                }

                // 교체 버튼 → 파일 선택 창
                if (replaceBtn && inputExisting) {
                    replaceBtn.addEventListener('click', function () {
                        inputExisting.click();
                    });
                }

                // 공용 change 핸들러
                function handleFileChosen(inputEl, nameLinkEl) {
                    const files = inputEl.files;
                    if (files && files.length > 0) {
                        const f = files[0];

                        // 상태/용량
                        if (statusEl) { statusEl.textContent = '교체 예정'; statusEl.className = 'badge bg-primary'; }
                        if (sizeEl)   { sizeEl.textContent   = fmtMB(f.size); }
                        if (removeField) removeField.value = 'false';
                        if (inputEl.form) inputEl.form.enctype = 'multipart/form-data';

                        // 파일명 업데이트
                        if (nameLinkEl) {
                            nameLinkEl.textContent = f.name;
                            const tmpUrl = URL.createObjectURL(f);
                            if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                            currentObjectUrl = tmpUrl;
                            nameLinkEl.setAttribute('href', tmpUrl);
                            nameLinkEl.setAttribute('target', '_blank');
                        } else {
                            // 신규 업로드 행: 인풋 아래에 표시
                            let hint = inputEl.nextElementSibling;
                            if (!hint || !hint.classList || !hint.classList.contains('form-text')) {
                                hint = document.createElement('div');
                                hint.className = 'form-text';
                                inputEl.insertAdjacentElement('afterend', hint);
                            }
                            hint.textContent = f.name + ' • ' + fmtMB(f.size);
                        }

                        // 새 파일 미리보기 표시 + 서버 미리보기 숨김
                        showPdfPreview(f);
                        hideServerPreview();

                    } else {
                        // 선택 취소 → 클라이언트 미리보기 지우고 서버 미리보기 다시 보이기
                        if (statusEl) { statusEl.textContent = '유지'; statusEl.className = 'badge bg-secondary'; }
                        clearClientPreview();
                        showServerPreview();
                    }
                }

                if (inputExisting) {
                    inputExisting.addEventListener('change', function () {
                        handleFileChosen(inputExisting, nameLinkExisting);
                    });
                }
                if (inputNew) {
                    inputNew.addEventListener('change', function () {
                        handleFileChosen(inputNew, null);
                    });
                }

                // 삭제 버튼 → 클라이언트/서버 미리보기 모두 숨김
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        if (inputExisting) inputExisting.value = '';
                        if (statusEl) { statusEl.textContent = '삭제 예정'; statusEl.className = 'badge bg-danger'; }
                        if (removeField) removeField.value = 'true';
                        clearClientPreview();
                        hideServerPreview(); // 삭제 예정이면 기존 서버 미리보기도 가림
                    });
                }

                // 페이지 떠날 때 objectURL 해제
                window.addEventListener('beforeunload', clearClientPreview);
            })();
        </script>


        <button type="submit" class="btn btn-primary">저장</button>
    </form>
</section>
</body>
</html>
