<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns="http://www.w3.org/1999/xhtml"
      th:replace="~{default-board::layout(~{::section})}">
<body>
<section class = "container">
    <h1>ê²Œì‹œíŒ</h1>
    <form th:object="${article}" th:action="@{/article/edit}" method="post">
        <input type="hidden" name="id" th:value="*{id}"/>
        <div class="mb-3">
            <label class="form-label">ì œëª©</label>
            <input type="text" class="form-control" th:field="*{title}">
            <p th:if="${#fields.hasErrors('title')}" th:errors="*{title}"
               class="text-danger">Title Error</p>
        </div>
        <div class="mb-3">
            <label class="form-label">ë‚´ìš©</label>
            <textarea class="form-control" th:field="*{description}" rows="10"></textarea>
            <p th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></p>
        </div>

        <!-- íŒŒì¼ -->
        <div class="mb-3">

            <!-- ìˆ¨ê¹€ í•„ë“œ: ì‚­ì œ ì—¬ë¶€ -->
            <input type="hidden" id="removeFileField" name="removeFile" value="false"/>

            <table class="table align-middle mb-2">
                <thead>
                <tr>
                    <th style="width:40%">íŒŒì¼ëª…</th>
                    <th style="width:20%">ì—…ë¡œë“œ ìƒíƒœ</th>
                    <th style="width:15%">ìš©ëŸ‰</th>
                    <th style="width:25%">ì•¡ì…˜</th>
                </tr>
                </thead>
                <tbody>
                <!-- ê¸°ì¡´ íŒŒì¼ ìˆì„ ë•Œ -->
                <tr th:if="${articleDTO != null and articleDTO.fileUrl != null and !#strings.isEmpty(articleDTO.fileUrl)}">
                    <td>
                        <span class="me-2">ğŸ“„</span>
                        <a th:href="${articleDTO.fileUrl}" target="_blank"
                           th:text="${articleDTO.fileTitle}">ì²¨ë¶€íŒŒì¼.pdf</a>
                    </td>
                    <td>
                        <span id="fileStatusExisting" class="badge bg-secondary">ìœ ì§€</span>
                    </td>
                    <td>
                          <span id="fileSizeTextExisting"
                                th:text="${#numbers.formatDecimal(articleDTO.fileSize/1024.0/1024.0,1,1)} + ' MB'">0 KB</span>
                    </td>
                    <td>
                        <!-- êµì²´: ìˆ¨ê²¨ì§„ file inputì„ ë²„íŠ¼ìœ¼ë¡œ íŠ¸ë¦¬ê±° -->
                        <input id="fileInputExisting" type="file" name="file" class="d-none"
                               accept=".pdf,.ppt,.pptx,.hwp,.hwpx,.doc,.docx"/>
                        <button type="button" class="btn btn-outline-primary btn-sm me-1" id="replaceBtnExisting">êµì²´</button>

                        <!-- ì‚­ì œ -->
                        <button type="button" class="btn btn-outline-danger btn-sm me-1" id="removeBtnExisting">ì‚­ì œ</button>

                        <!-- ë‹¤ìš´ë¡œë“œ ë°”ë¡œê°€ê¸°(ì„ íƒ) -->
                        <a class="btn btn-outline-secondary btn-sm" th:href="${articleDTO.fileUrl}" download>ë‹¤ìš´ë¡œë“œ</a>
                    </td>
                </tr>

                <!-- ê¸°ì¡´ íŒŒì¼ ì—†ì„ ë•Œ: ìƒˆ ì—…ë¡œë“œ -->
                <tr th:if="${articleDTO == null or articleDTO.fileUrl == null or #strings.isEmpty(articleDTO.fileUrl)}">
                    <td colspan="4">
                        <input id="fileInputNew" type="file" name="file" class="form-control"
                               accept=".pdf,.ppt,.pptx,.hwp,.hwpx,.doc,.docx"/>
                        <div class="form-text">í—ˆìš© í™•ì¥ì: PDF/PPT/PPTX/HWP/HWPX/DOC/DOCX Â· ìµœëŒ€ 20MB</div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- ìœ íš¨ì„± ì—ëŸ¬ -->
            <p th:if="${#fields.hasErrors('file')}" th:errors="*{file}" class="text-danger mt-1"></p>

            <!-- PDF ë¯¸ë¦¬ë³´ê¸°(ì„ íƒ) -->
            <div id="serverPdfPreview" class="mt-3"
                 th:if="${articleDTO != null and articleDTO.fileContentType != null and articleDTO.fileContentType.contains('pdf')}">
                <embed th:src="@{${articleDTO.fileUrl}}" type="application/pdf" width="100%" height="600"/>
            </div>
        </div>

        <script>
            (function () {
                // ê³µìš© ìœ í‹¸
                function fmtMB(bytes) {
                    return (bytes / 1024 / 1024).toFixed(1) + ' MB';
                }
                function isPdf(file) {
                    if (!file) return false;
                    if (file.type && file.type.toLowerCase().includes('pdf')) return true;
                    return /\.pdf$/i.test(file.name || '');
                }

                // ì„œë²„ ë¯¸ë¦¬ë³´ê¸° ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
                function hideServerPreview() {
                    var el = document.getElementById('serverPdfPreview');
                    if (el) el.style.display = 'none';
                }
                function showServerPreview() {
                    var el = document.getElementById('serverPdfPreview');
                    if (el) el.style.display = '';
                }

                // í´ë¼ì´ì–¸íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ
                function ensurePreviewContainer() {
                    var container = document.getElementById('clientPdfPreview');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'clientPdfPreview';
                        container.className = 'mt-3';
                        var fileBlock = document.querySelector('.mb-3 .table')?.parentElement || document.querySelector('.mb-3');
                        (fileBlock || document.body).appendChild(container);
                    }
                    return container;
                }

                let currentObjectUrl = null;
                function clearClientPreview() {
                    const container = document.getElementById('clientPdfPreview');
                    if (container) container.innerHTML = '';
                    if (currentObjectUrl) {
                        URL.revokeObjectURL(currentObjectUrl);
                        currentObjectUrl = null;
                    }
                }
                function showPdfPreview(file) {
                    clearClientPreview();
                    if (!isPdf(file)) return;
                    const url = URL.createObjectURL(file);
                    currentObjectUrl = url;
                    const container = ensurePreviewContainer();
                    const embed = document.createElement('embed');
                    embed.setAttribute('src', url);
                    embed.setAttribute('type', 'application/pdf');
                    embed.setAttribute('width', '100%');
                    embed.setAttribute('height', '420');
                    container.appendChild(embed);
                }

                // ìš”ì†Œ ì°¸ì¡°(ê¸°ì¡´/ì‹ ê·œ ì¼€ì´ìŠ¤ ì¤‘ ìˆëŠ” ê²ƒë§Œ)
                const inputExisting = document.getElementById('fileInputExisting');
                const inputNew      = document.getElementById('fileInputNew');
                const replaceBtn    = document.getElementById('replaceBtnExisting');
                const removeBtn     = document.getElementById('removeBtnExisting');
                const statusEl      = document.getElementById('fileStatusExisting');
                const sizeEl        = document.getElementById('fileSizeTextExisting');
                const removeField   = document.getElementById('removeFileField');

                // ê¸°ì¡´ íŒŒì¼ í–‰ì—ì„œ íŒŒì¼ëª… ë§í¬ ìš”ì†Œ
                let nameLinkExisting = null;
                if (inputExisting) {
                    const row = inputExisting.closest('tr');
                    if (row) nameLinkExisting = row.querySelector('a[href]');
                }

                // êµì²´ ë²„íŠ¼ â†’ íŒŒì¼ ì„ íƒ ì°½
                if (replaceBtn && inputExisting) {
                    replaceBtn.addEventListener('click', function () {
                        inputExisting.click();
                    });
                }

                // ê³µìš© change í•¸ë“¤ëŸ¬
                function handleFileChosen(inputEl, nameLinkEl) {
                    const files = inputEl.files;
                    if (files && files.length > 0) {
                        const f = files[0];

                        // ìƒíƒœ/ìš©ëŸ‰
                        if (statusEl) { statusEl.textContent = 'êµì²´ ì˜ˆì •'; statusEl.className = 'badge bg-primary'; }
                        if (sizeEl)   { sizeEl.textContent   = fmtMB(f.size); }
                        if (removeField) removeField.value = 'false';
                        if (inputEl.form) inputEl.form.enctype = 'multipart/form-data';

                        // íŒŒì¼ëª… ì—…ë°ì´íŠ¸
                        if (nameLinkEl) {
                            nameLinkEl.textContent = f.name;
                            const tmpUrl = URL.createObjectURL(f);
                            if (currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
                            currentObjectUrl = tmpUrl;
                            nameLinkEl.setAttribute('href', tmpUrl);
                            nameLinkEl.setAttribute('target', '_blank');
                        } else {
                            // ì‹ ê·œ ì—…ë¡œë“œ í–‰: ì¸í’‹ ì•„ë˜ì— í‘œì‹œ
                            let hint = inputEl.nextElementSibling;
                            if (!hint || !hint.classList || !hint.classList.contains('form-text')) {
                                hint = document.createElement('div');
                                hint.className = 'form-text';
                                inputEl.insertAdjacentElement('afterend', hint);
                            }
                            hint.textContent = f.name + ' â€¢ ' + fmtMB(f.size);
                        }

                        // ìƒˆ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ + ì„œë²„ ë¯¸ë¦¬ë³´ê¸° ìˆ¨ê¹€
                        showPdfPreview(f);
                        hideServerPreview();

                    } else {
                        // ì„ íƒ ì·¨ì†Œ â†’ í´ë¼ì´ì–¸íŠ¸ ë¯¸ë¦¬ë³´ê¸° ì§€ìš°ê³  ì„œë²„ ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ë³´ì´ê¸°
                        if (statusEl) { statusEl.textContent = 'ìœ ì§€'; statusEl.className = 'badge bg-secondary'; }
                        clearClientPreview();
                        showServerPreview();
                    }
                }

                if (inputExisting) {
                    inputExisting.addEventListener('change', function () {
                        handleFileChosen(inputExisting, nameLinkExisting);
                    });
                }
                if (inputNew) {
                    inputNew.addEventListener('change', function () {
                        handleFileChosen(inputNew, null);
                    });
                }

                // ì‚­ì œ ë²„íŠ¼ â†’ í´ë¼ì´ì–¸íŠ¸/ì„œë²„ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‘ ìˆ¨ê¹€
                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        if (inputExisting) inputExisting.value = '';
                        if (statusEl) { statusEl.textContent = 'ì‚­ì œ ì˜ˆì •'; statusEl.className = 'badge bg-danger'; }
                        if (removeField) removeField.value = 'true';
                        clearClientPreview();
                        hideServerPreview(); // ì‚­ì œ ì˜ˆì •ì´ë©´ ê¸°ì¡´ ì„œë²„ ë¯¸ë¦¬ë³´ê¸°ë„ ê°€ë¦¼
                    });
                }

                // í˜ì´ì§€ ë– ë‚  ë•Œ objectURL í•´ì œ
                window.addEventListener('beforeunload', clearClientPreview);
            })();
        </script>


        <button type="submit" class="btn btn-primary">ì €ì¥</button>
    </form>
</section>
</body>
</html>
